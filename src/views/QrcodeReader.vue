<style scoped>
/* ä»¿å¾®ä¿¡æ‰«ä¸€æ‰«æ•´ä½“æ ·å¼ */
.qrcode-reader-container {
  position: relative;
  min-height: 100vh;
  width: 100%;
  overflow: hidden;
  background: linear-gradient(135deg, #1296db, #15b7d1);
  display: flex;
  flex-direction: column;
}

/* é¡¶éƒ¨å¯¼èˆªæ  */
.top-nav {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  padding: 20px 16px 12px;
  z-index: 100;
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: white;
  font-size: 16px;
}

.back-btn {
  font-size: 18px;
  cursor: pointer;
  z-index: 101;
}

.scan-title {
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  font-size: 16px;
  font-weight: 500;
}

.scan-actions {
  display: flex;
  gap: 20px;
}

.scan-action-btn {
  font-size: 18px;
  cursor: pointer;
  z-index: 101;
}

/* æ‰«æåŒºåŸŸ */
.scan-area {
  position: relative;
  width: 100%;
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
}

/* æ‰«ææ¡† */
.scan-box {
  position: relative;
  width: 250px;
  height: 250px;
  margin-top: 60px;
  border: 2px solid #fff;
  border-radius: 8px;
  box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.5);
}

.scan-line {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 2px;
  background: linear-gradient(to bottom, #00ff00, #00cc00);
  animation: scan 2s linear infinite;
  box-shadow: 0 0 10px rgba(0, 255, 0, 0.8);
}

@keyframes scan {
  0% {
    top: 0;
  }
  50% {
    top: calc(100% - 2px);
  }
  100% {
    top: 0;
  }
}

/* æ‰«ææ¡†å››ä¸ªè§’ */
.scan-corner {
  position: absolute;
  width: 20px;
  height: 20px;
  border: 2px solid #fff;
}

.scan-corner-tl {
  top: -2px;
  left: -2px;
  border-right: none;
  border-bottom: none;
  border-radius: 4px 0 0 0;
}

.scan-corner-tr {
  top: -2px;
  right: -2px;
  border-left: none;
  border-bottom: none;
  border-radius: 0 4px 0 0;
}

.scan-corner-bl {
  bottom: -2px;
  left: -2px;
  border-right: none;
  border-top: none;
  border-radius: 0 0 0 4px;
}

.scan-corner-br {
  bottom: -2px;
  right: -2px;
  border-left: none;
  border-top: none;
  border-radius: 0 0 4px 0;
}

/* æ‰«æåŒºåŸŸæç¤ºæ–‡å­— */
.scan-tips {
  position: absolute;
  bottom: 120px;
  color: white;
  text-align: center;
  width: 100%;
  font-size: 14px;
  opacity: 0.9;
}

/* åº•éƒ¨æ“ä½œæŒ‰é’® */
.bottom-actions {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  padding: 20px 0;
  background: rgba(0, 0, 0, 0.3);
  display: flex;
  justify-content: space-around;
  align-items: center;
  z-index: 100;
}

.action-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  color: white;
  font-size: 12px;
}

.action-icon {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 6px;
  font-size: 24px;
  cursor: pointer;
}

/* äºŒç»´ç æµè§†é¢‘é®ç½© */
.qrcode-stream-container {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  overflow: hidden;
}

/* æš‚åœæ‰«ææç¤º */
.scan-confirmation {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 200;
  color: white;
}

.scan-confirmation-text {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 20px;
}

/* æ–‡æœ¬ç»“æœå¼¹çª— */
.text-result-dialog {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 300;
}

.dialog-content {
  background: white;
  width: 80%;
  max-width: 350px;
  border-radius: 10px;
  overflow: hidden;
}

.dialog-header {
  padding: 15px;
  background: #f5f5f5;
  font-weight: bold;
  text-align: center;
  border-bottom: 1px solid #eee;
}

.dialog-body {
  padding: 20px;
  max-height: 200px;
  overflow-y: auto;
}

.result-text {
  word-break: break-all;
  line-height: 1.5;
  color: #333;
  font-size: 14px;
}

.dialog-footer {
  display: flex;
  border-top: 1px solid #eee;
  padding: 10px 0;
}

.copy-btn, .continue-btn, .cancel-btn {
  flex: 1;
  padding: 12px 0;
  border: none;
  font-size: 16px;
  cursor: pointer;
}

.copy-btn {
  background-color: #1296db;
  color: white;
  border-right: 1px solid #eee;
}

.continue-btn {
  background-color: #1296db;
  color: white;
}

.cancel-btn {
  background-color: #f0f0f0;
  color: #333;
}

/* æ§åˆ¶é¢æ¿å¼¹çª— */
.controls-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 2000;
  display: flex;
  justify-content: center;
  align-items: center;
}

.controls-content {
  background: white;
  width: 90%;
  max-width: 500px;
  max-height: 80vh;
  border-radius: 10px;
  padding: 20px;
  overflow-y: auto;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.controls-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-bottom: 15px;
  border-bottom: 1px solid #eee;
  margin-bottom: 15px;
  font-size: 16px;
  font-weight: bold;
}

.close-btn {
  font-size: 20px;
  cursor: pointer;
  color: #999;
}

.control-group {
  margin-bottom: 15px;
}

.control-title {
  font-size: 14px;
  font-weight: 600;
  color: #333;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
}

.radio-group {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
}

.radio-item {
  display: flex;
  align-items: center;
  font-size: 13px;
  cursor: pointer;
  padding: 6px 12px;
  border-radius: 20px;
  border: 1px solid #ddd;
  transition: all 0.3s;
  background-color: #f8f8f8;
}

.radio-item:hover {
  border-color: #1296db;
  background-color: #eef7ff;
}

.radio-item input {
  margin-right: 6px;
}

.radio-item input[type="radio"]:checked + span {
  color: #1296db;
  font-weight: 500;
}

.result-container {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  padding: 15px 20px;
  background-color: rgba(255, 255, 255, 0.95);
  border-top: 1px solid #eee;
  z-index: 1000;
}

.result-title {
  font-size: 14px;
  font-weight: 600;
  color: #333;
  margin-bottom: 8px;
}

.result-content {
  font-size: 14px;
  word-break: break-all;
  color: #666;
}

.error-box {
  position: absolute;
  top: 80px;
  left: 20px;
  right: 20px;
  background-color: rgba(255, 58, 58, 0.9);
  color: white;
  padding: 10px;
  border-radius: 8px;
  text-align: center;
  z-index: 150;
}

.action-buttons {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.btn {
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}

.btn-primary {
  background-color: #1296db;
  color: white;
  flex: 1;
}

/* é€‚é…ç§»åŠ¨ç«¯ */
@media (max-width: 768px) {
  .scan-box {
    width: 220px;
    height: 220px;
  }
  
  .top-nav {
    padding: 15px 10px 10px;
  }
  
  .bottom-actions {
    padding: 15px 0;
  }
}
</style>

<template>
  <div class="qrcode-reader-container">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="top-nav">
      <div class="scan-title">æ‰«ç </div>
      <div class="scan-actions">
        <div class="scan-action-btn" @click="switchCamera">åˆ‡æ¢</div>
        <div class="scan-action-btn" @click="openFileSelector">ä¸Šä¼ </div>
      </div>
    </div>
    
    <!-- äºŒç»´ç æµè§†é¢‘ -->
    <div class="qrcode-stream-container">
      <qrcode-stream
          ref="videoRef"
          :constraints="selectedConstraints"
          :track="trackFunctionSelected ? trackFunctionSelected.value : undefined"
          :formats="selectedBarcodeFormats"
          :paused="paused"
          @error="onError"
          @detect="onDetect"
          @camera-on="onCameraOn"
          @camera-off="onCameraOff"
      />
    </div>
    
    <!-- æ‰«æåŒºåŸŸ -->
    <div class="scan-area">
      <div class="scan-box">
        <div class="scan-line"></div>
        <div class="scan-corner scan-corner-tl"></div>
        <div class="scan-corner scan-corner-tr"></div>
        <div class="scan-corner scan-corner-bl"></div>
        <div class="scan-corner scan-corner-br"></div>
      </div>
      <div class="scan-tips">å°†äºŒç»´ç /æ¡ç æ”¾å…¥æ¡†å†…ï¼Œå³å¯è‡ªåŠ¨æ‰«æ</div>
    </div>
    
    <!-- é”™è¯¯ä¿¡æ¯ -->
    <div v-if="error" class="error-box">{{ error }}</div>
    
    
    
    <!-- æ–‡æœ¬ç»“æœå¼¹çª— -->
    <div 
      v-if="showTextResultDialog && !isUrl(result)" 
      class="text-result-dialog"
    >
      <div class="dialog-content">
        <div class="dialog-header">æ‰«æç»“æœ</div>
        <div class="dialog-body">
          <div class="result-text">{{ result }}</div>
        </div>
        <div class="dialog-footer">
          <button class="copy-btn" @click="copyText">å¤åˆ¶</button>
          <button class="continue-btn" @click="closeTextResultDialog">ç»§ç»­æ‰«æ</button>
        </div>
      </div>
    </div>
    
    <!-- URLç»“æœå¤„ç† -->
    <div
        v-if="showScanConfirmation && isUrl(result)"
        class="scan-confirmation"
    >
      <div class="scan-confirmation-text">æ£€æµ‹åˆ°é“¾æ¥</div>
      <div class="scan-result">{{ result }}</div>
      <div class="dialog-footer">
        <button class="cancel-btn" @click="closeUrlDialog">å–æ¶ˆ</button>
        <button class="continue-btn" @click="openUrl">æ‰“å¼€é“¾æ¥</button>
      </div>
    </div>
    
        <!-- åº•éƒ¨æ“ä½œæŒ‰é’® -->
    <div class="bottom-actions">
      <div class="action-btn" @click="openFileSelector" title="ä¸Šä¼ å›¾ç‰‡">
        <div class="action-icon">ğŸ“</div>
      </div>
      <div class="action-btn" @click="openControls" title="æ‰«æè®¾ç½®">
        <div class="action-icon">âš™ï¸</div>
      </div>
    </div>
    
    <!-- æ–‡ä»¶ä¸Šä¼ è¾“å…¥æ¡†ï¼ˆéšè—ï¼‰ -->
    <input 
      type="file" 
      ref="fileInput" 
      accept="image/*" 
      @change="handleFileUpload" 
      style="display: none" 
    />
    
    <!-- æ§åˆ¶é¢æ¿å¼¹çª— -->
    <div v-if="showControls" class="controls-modal">
      <div class="controls-content">
        <div class="controls-header">
          <span>æ‰«æè®¾ç½®</span>
          <span class="close-btn" @click="closeControls">âœ•</span>
        </div>
        
        <!-- æ‘„åƒå¤´é€‰æ‹© -->
        <div class="control-group">
          <div class="control-title">ğŸ“· é€‰æ‹©æ‘„åƒå¤´</div>
          <div class="radio-group">
            <label 
              v-for="option in constraintOptions" 
              :key="option.label" 
              class="radio-item"
            >
              <input 
                type="radio" 
                :name="'camera-' + option.label" 
                :value="option.constraints" 
                v-model="selectedConstraints"
              />
              <span>{{ option.label }}</span>
            </label>
          </div>
        </div>
        
        <!-- è¿½è¸ªåŠŸèƒ½é€‰æ‹© -->
        <div class="control-group">
          <div class="control-title">ğŸ” é€‰æ‹©è¿½è¸ªåŠŸèƒ½</div>
          <div class="radio-group">
            <label 
              v-for="option in trackFunctionOptions" 
              :key="option.text" 
              class="radio-item"
            >
              <input 
                type="radio" 
                :name="'track-' + option.text" 
                :value="option" 
                v-model="trackFunctionSelected"
              />
              <span>{{ option.text }}</span>
            </label>
          </div>
        </div>
        
        <!-- æ¡å½¢ç æ ¼å¼é€‰æ‹© -->
        <div class="control-group">
          <div class="control-title">âš™ï¸ é€‰æ‹©æ‰«ææ ¼å¼</div>
          <div class="radio-group">
            <label 
              v-for="(mode, index) in Object.keys(barcodeModes)" 
              :key="index" 
              class="radio-item"
            >
              <input 
                type="radio" 
                name="barcode-mode" 
                :value="mode" 
                v-model="selectedBarcodeMode"
              />
              <span>
                {{ mode === 'both' ? 'æ‰«ææ¡å½¢ç å’ŒäºŒç»´ç ' : 
                   mode === 'barcodes' ? 'ä»…æ‰«ææ¡å½¢ç ' : 'ä»…æ‰«æäºŒç»´ç ' }}
              </span>
            </label>
          </div>
        </div>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="action-buttons">
          <button 
            class="btn btn-primary" 
            @click="paused = !paused; closeControls()"
          >
            {{ paused ? 'â–¶ï¸ ç»§ç»­/é‡æ–°æ‰«æ' : 'â¸ï¸ æš‚åœæ‰«æ' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed } from 'vue';
import { useRouter } from 'vue-router';
// å¯¼å…¥äºŒç»´ç è¯†åˆ«ç»„ä»¶
import { QrcodeStream } from 'vue-qrcode-reader';

const router = useRouter();

// ç»“æœå­˜å‚¨
let result = ref('');

// å®šä¹‰æ˜¯å¦æš‚åœçš„å˜é‡
const paused = ref(false);
// æ§åˆ¶æ‰«æç¡®è®¤æ¡†æ˜¾ç¤ºä¸å¦çš„å˜é‡
const showScanConfirmation = ref(false);

// ç»˜åˆ¶æ£€æµ‹åˆ°çš„æ¡å½¢ç è½®å»“
function paintOutline(detectedCodes, ctx) {
  for (const detectedCode of detectedCodes) {
    const [firstPoint, ...otherPoints] = detectedCode.cornerPoints;

    ctx.strokeStyle = 'red';

    ctx.beginPath();
    ctx.moveTo(firstPoint.x, firstPoint.y);
    for (const {x, y} of otherPoints) {
      ctx.lineTo(x, y);
    }
    ctx.lineTo(firstPoint.x, firstPoint.y);
    ctx.closePath();
    ctx.stroke();
  }
}

// ç»˜åˆ¶æ£€æµ‹åˆ°çš„æ¡å½¢ç è¾¹ç•Œæ¡†
function paintBoundingBox(detectedCodes, ctx) {
  for (const detectedCode of detectedCodes) {
    const {
      boundingBox: {x, y, width, height}
    } = detectedCode;

    ctx.lineWidth = 2;
    ctx.strokeStyle = '#007bff';
    ctx.strokeRect(x, y, width, height);
  }
}

// åœ¨ä¸­å¿ƒç»˜åˆ¶æ–‡å­—
function paintCenterText(detectedCodes, ctx) {
  for (const detectedCode of detectedCodes) {
    const {boundingBox, rawValue} = detectedCode;

    const centerX = boundingBox.x + boundingBox.width / 2;
    const centerY = boundingBox.y + boundingBox.height / 2;

    const fontSize = Math.max(12, (50 * boundingBox.width) / ctx.canvas.width);

    ctx.font = `bold ${fontSize}px sans-serif`;
    ctx.textAlign = 'center';

    ctx.lineWidth = 3;
    ctx.strokeStyle = '#35495e';
    ctx.strokeText(detectedCode.rawValue, centerX, centerY);

    ctx.fillStyle = '#5cb984';
    ctx.fillText(rawValue, centerX, centerY);
  }
}

// è®¾ç½®è·Ÿè¸ªåŠŸèƒ½é€‰é¡¹
let trackFunctionOptions = [
  {text: 'æ— ï¼ˆé»˜è®¤ï¼‰', value: undefined},
  {text: 'å›¾ç è¾¹æ¡†çº¿', value: paintOutline},
  {text: 'å›¾ç èŒƒå›´çº¿', value: paintBoundingBox},
  {text: 'å±…ä¸­æ–‡å­—', value: paintCenterText}
];

// å½“å‰é€‰ä¸­çš„è·Ÿè¸ªåŠŸèƒ½ï¼Œé»˜è®¤æ˜¯ï¼šæ— 
let trackFunctionSelected = ref(trackFunctionOptions[0]);

// åˆå§‹åŒ–æ‘„åƒå¤´é€‰é¡¹ï¼šé»˜è®¤æœ‰å‰ç½®æ‘„åƒå¤´å’Œåç½®æ‘„åƒå¤´
let defaultConstraintOptions = [
  {label: 'åç½®æ‘„åƒå¤´', constraints: {facingMode: 'environment'}},
  {label: 'å‰ç½®æ‘„åƒå¤´', constraints: {facingMode: 'user'}}
];
// å­˜å‚¨æ‰€æœ‰çš„å¯ç”¨æ‘„åƒå¤´ï¼Œå¹¶å°†é»˜è®¤çš„æ‘„åƒå¤´æ·»åŠ åˆ°åˆ—è¡¨ä¸­
let constraintOptions = ref(defaultConstraintOptions);

// ç”¨äºé€‰æ‹©å›¾ç æ¨¡å¼
const selectedBarcodeMode = ref('qrcodes');

// è®¡ç®—å½“å‰é€‰ä¸­çš„æ¡å½¢ç æ ¼å¼
let selectedBarcodeFormats = computed(() => {
  return barcodeModes[selectedBarcodeMode.value];
});

// åˆå§‹åŒ–æ‰€æœ‰çš„æ‘„åƒå¤´ï¼šå°†æ£€æµ‹åˆ°çš„æ‘„åƒå¤´ä¿¡æ¯æ·»åŠ åˆ°åˆ—è¡¨ä¸­
async function onCameraOn() {
  // æ‘„åƒå¤´æ‰“å¼€æ—¶å…³é—­æ‰«æç¡®è®¤æ¡†
  showScanConfirmation.value = false
  // è·å–è§†é¢‘çš„å°ºå¯¸

  // è·å–æ‰€æœ‰å¯ç”¨çš„åª’ä½“è®¾å¤‡
  let devices = await navigator.mediaDevices.enumerateDevices();
  // è·å–è®¾å¤‡ä¸­çš„æ‘„åƒå¤´
  let videoDevices = devices.filter(({kind}) => kind === 'videoinput');

  // å°†é»˜è®¤çš„æ‘„åƒå¤´å’Œæ£€æµ‹åˆ°çš„æ‘„åƒå¤´åŠ å…¥åˆ°åˆ—è¡¨ä¸­
  constraintOptions.value = [
    ...defaultConstraintOptions,
    ...videoDevices.map(({deviceId, label}) => ({
      label: `${label}`,
      constraints: {deviceId}
    }))
  ];
  // æ‘„åƒå¤´åˆå§‹åŒ–å®Œæ¯•ï¼Œæ¸…é™¤é”™è¯¯ä¿¡æ¯
  error.value = '';
}

async function onCameraOff() {
  // æ‘„åƒå¤´å…³é—­æ—¶æ‰“å¼€æ‰«æç¡®è®¤æ¡†
  showScanConfirmation.value = true
}

// æ–‡æœ¬ç»“æœå¼¹çª—æ˜¾ç¤ºæ§åˆ¶
const showTextResultDialog = ref(false);

// æ§åˆ¶é¢æ¿å¼¹çª—æ˜¾ç¤ºæ§åˆ¶
const showControls = ref(false);

// æ–‡ä»¶ä¸Šä¼ è¾“å…¥æ¡†å¼•ç”¨
const fileInput = ref(null);

// å¤„ç†æ‰«æç»“æœ
function onDetect(detectedCodes) {
  // å–ç¬¬ä¸€ä¸ªæ£€æµ‹åˆ°çš„ç»“æœ
  if (detectedCodes && detectedCodes.length > 0) {
    result.value = detectedCodes[0].rawValue;
    
    // æ ¹æ®ç»“æœç±»å‹æ˜¾ç¤ºä¸åŒç•Œé¢
    if (isUrl(result.value)) {
      showScanConfirmation.value = true; // æ˜¾ç¤ºURLç¡®è®¤ç•Œé¢
    } else {
      showTextResultDialog.value = true; // æ˜¾ç¤ºæ–‡æœ¬ç»“æœå¼¹çª—
    }
    
    // æš‚åœæ‰«æ
    paused.value = true;
  }
}

// æ‰“å¼€URL
function openUrl() {
  window.open(result.value, '_blank');
  closeUrlDialog();
}

// å…³é—­URLå¯¹è¯æ¡†
function closeUrlDialog() {
  showScanConfirmation.value = false;
  resetScanner();
}

// å…³é—­æ–‡æœ¬ç»“æœå¯¹è¯æ¡†
function closeTextResultDialog() {
  showTextResultDialog.value = false;
  resetScanner();
}

// é‡ç½®æ‰«æå™¨
function resetScanner() {
  result.value = '';
  paused.value = false;
}

// å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
async function copyText() {
  try {
    await navigator.clipboard.writeText(result.value);
    alert('å¤åˆ¶æˆåŠŸ');
  } catch (err) {
    console.error('å¤åˆ¶å¤±è´¥', err);
    // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨æ—§ç‰ˆå¤åˆ¶æ–¹æ³•
    fallbackCopyTextToClipboard(result.value);
  }
}

// é™çº§å¤åˆ¶æ–¹æ³•
function fallbackCopyTextToClipboard(text) {
  const textArea = document.createElement("textarea");
  textArea.value = text;
  
  // é¿å…æ»šåŠ¨åˆ°åº•éƒ¨
  textArea.style.top = "0";
  textArea.style.left = "0";
  textArea.style.position = "fixed";
  textArea.style.opacity = "0";
  
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();
  
  try {
    const successful = document.execCommand('copy');
    if (successful) {
      alert('å¤åˆ¶æˆåŠŸ');
    } else {
      alert('å¤åˆ¶å¤±è´¥');
    }
  } catch (err) {
    console.error('å¤åˆ¶å¤±è´¥', err);
    alert('å¤åˆ¶å¤±è´¥');
  }
  
  document.body.removeChild(textArea);
}

function isUrl(str) {
  try {
    new URL(str);
    return true;
  } catch {
    return str.startsWith('http://') || str.startsWith('https://');
  }
}

// åˆ‡æ¢æ‘„åƒå¤´
let currentFacingMode = ref('environment');
let selectedConstraints = computed(() => {
  return { facingMode: currentFacingMode.value };
});

function switchCamera() {
  currentFacingMode.value = currentFacingMode.value === 'environment' ? 'user' : 'environment';
}

// æ‰“å¼€ç›¸å†ŒåŠŸèƒ½ï¼ˆæ¨¡æ‹Ÿï¼‰
function openAlbum() {
  alert('ç›¸å†ŒåŠŸèƒ½æš‚æœªå®ç°');
}

// æ¨¡æ‹Ÿè¿”å›åŠŸèƒ½
function goBack() {
  router.go(-1);
}

// æ‰“å¼€æ§åˆ¶é¢æ¿
function openControls() {
  showControls.value = true;
}

// å…³é—­æ§åˆ¶é¢æ¿
function closeControls() {
  showControls.value = false;
}

// æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨
function openFileSelector() {
  fileInput.value.click();
}

// å¤„ç†æ–‡ä»¶ä¸Šä¼ 
function handleFileUpload(event) {
  const file = event.target.files[0];
  
  if (!file) return;
  
  // éªŒè¯æ–‡ä»¶ç±»å‹
  if (!file.type.startsWith('image/')) {
    alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
    return;
  }
  
  // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆä¾‹å¦‚é™åˆ¶ä¸º5MBï¼‰
  const maxSize = 5 * 1024 * 1024; // 5MB
  if (file.size > maxSize) {
    alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB');
    return;
  }
  
  // ä½¿ç”¨QRç è§£æåº“è¯»å–å›¾ç‰‡ä¸­çš„QRç 
  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„å›¾åƒå…ƒç´ 
      const img = new Image();
      img.src = e.target.result;
      
      img.onload = async () => {
        // åˆ›å»ºcanvasæ¥å¤„ç†å›¾åƒ
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = img.width;
        canvas.height = img.height;
        
        // å°†å›¾åƒç»˜åˆ¶åˆ°canvasä¸Š
        ctx.drawImage(img, 0, 0, img.width, img.height);
        
        // è·å–å›¾åƒæ•°æ®
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        
        // ä½¿ç”¨jsqråº“è§£æQRç 
        import('jsqr').then(({ default: jsQR }) => {
          const code = jsQR(imageData.data, imageData.width, imageData.height);
          
          if (code) {
            result.value = code.data;
            
            // æ ¹æ®ç»“æœç±»å‹æ˜¾ç¤ºä¸åŒç•Œé¢
            if (isUrl(result.value)) {
              showScanConfirmation.value = true; // æ˜¾ç¤ºURLç¡®è®¤ç•Œé¢
            } else {
              showTextResultDialog.value = true; // æ˜¾ç¤ºæ–‡æœ¬ç»“æœå¼¹çª—
            }
            
            // æš‚åœæ‘„åƒå¤´æ‰«æ
            paused.value = true;
          } else {
            alert('æœªåœ¨å›¾ç‰‡ä¸­æ‰¾åˆ°äºŒç»´ç ');
          }
        });
      };
    } catch (error) {
      console.error('å¤„ç†å›¾åƒæ—¶å‡ºé”™:', error);
      alert('å¤„ç†å›¾ç‰‡æ—¶å‡ºé”™');
    }
  };
  
  reader.readAsDataURL(file);
}

// å®šä¹‰æ¡å½¢ç å’ŒäºŒç»´ç çš„æ ¼å¼
const barcodeModes = {
  barcodes: ['code_128', 'code_39', 'codabar', 'ean_13', 'itf'],
  qrcodes: ['qr_code'],
  both: ['code_128', 'code_39', 'codabar', 'ean_13', 'itf', 'qr_code']
};

// é”™è¯¯ä¿¡æ¯å­˜å‚¨
let error = ref('');

// å¤„ç†é”™è¯¯ä¿¡æ¯
function onError(err) {
  // å­˜å‚¨é”™è¯¯ä¿¡æ¯åï¼Œå¹¶ç”¨ä¸­æ‹¬å·åŒ…å›´
  error.value = `[${err.name}]: `;
  // å®å®šä¹‰é”™è¯¯ä¿¡æ¯
  if (err.name === 'NotAllowedError') {
    error.value += 'æ‚¨éœ€è¦æˆäºˆç›¸æœºè®¿é—®æƒé™';
  } else if (err.name === 'NotFoundError') {
    error.value += 'æ­¤è®¾å¤‡ä¸Šæ²¡æœ‰æ‘„åƒå¤´';
  } else if (err.name === 'NotSupportedError') {
    error.value += 'éœ€è¦å®‰å…¨ä¸Šä¸‹æ–‡ï¼ˆHTTPSã€localhostï¼‰';
  } else if (err.name === 'NotReadableError') {
    error.value += 'å¯èƒ½æœ‰åˆ«çš„å¹³å°æ­£åœ¨å ç”¨æ‘„åƒå¤´';
  } else if (err.name === 'OverconstrainedError') {
    error.value += 'å®‰è£…çš„æ‘„åƒå¤´ä¸åˆé€‚ï¼Œæ‚¨éœ€è¦æ¢å°è®¾å¤‡ä½¿ç”¨';
  } else if (err.name === 'StreamApiNotSupportedError') {
    error.value += 'æ­¤æµè§ˆå™¨ä¸æ”¯æŒæµAPIï¼Œæ‚¨éœ€è¦æ¢ä¸ªæµè§ˆå™¨ä½¿ç”¨';
  } else if (err.name === 'InsecureContextError') {
    error.value += 'åªæœ‰åœ¨å®‰å…¨çš„æƒ…å†µä¸‹æ‰å…è®¸è®¿é—®æ‘„åƒå¤´ã€‚ä½¿ç”¨HTTPSæˆ–localhostè€Œä¸æ˜¯HTTPã€‚';
  } else {
    // ä¸å¸¸è§çš„é”™è¯¯ä¿¡æ¯ï¼ŒåŸæ–‡æ˜¾ç¤º
    error.value += err.message;
  }
}
</script>